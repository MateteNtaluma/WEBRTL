<!DOCTYPE html>
<html>
<head>
  <title>Meu Mapa</title>
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://www.openlayers.org/api/OpenLayers.js"></script>
  <script>
    let map;
    let startPoint;
    let lastPoint;
    let startTime;
    let endTime;

    function initMap() {
      // Inicialize o mapa
      map = new OpenLayers.Map("map");
      map.addLayer(new OpenLayers.Layer.OSM());

      // Defina a exibição inicial do mapa
      var lonLat = new OpenLayers.LonLat(-46.633308, -23.550520).transform(
        new OpenLayers.Projection("EPSG:4326"),
        map.getProjectionObject()
      );
      map.setCenter(lonLat, 12);

      // Registrar o tempo de permanência em um local
      map.events.register("click", map, function (e) {
        if (!startTime) {
          startTime = new Date();
          startPoint = map.getLonLatFromPixel(e.xy);
        } else {
          endTime = new Date();
          lastPoint = map.getLonLatFromPixel(e.xy);

          const duration = (endTime - startTime) / 1000; // duração em segundos
          console.log(`Tempo de permanência: ${duration} segundos`);

          enviarDados(duration);
          startTime = null;
          startPoint = null;
        }
      });

      // Atualizar o percurso em tempo real
      setInterval(updateRoute, 5000); // atualizar a cada 5 segundos
    }

    function updateRoute() {
      if (startPoint && lastPoint) {
        var style = {
          strokeColor: "#0000ff",
          strokeOpacity: 0.7,
          strokeWidth: 5
        };

        var vectorLayer = new OpenLayers.Layer.Vector("Route");
        var features = [];

        var startPointTransformed = startPoint.transform(
          map.getProjectionObject(),
          new OpenLayers.Projection("EPSG:4326")
        );
        var lastPointTransformed = lastPoint.transform(
          map.getProjectionObject(),
          new OpenLayers.Projection("EPSG:4326")
        );

        var lineString = new OpenLayers.Geometry.LineString([
          startPointTransformed,
          lastPointTransformed
        ]);

        var lineFeature = new OpenLayers.Feature.Vector(lineString, null, style);
        vectorLayer.addFeatures([lineFeature]);
        map.addLayer(vectorLayer);
      }
    }

    function enviarDados(duration) {
      const dados = {
        tempoPermanencia: duration,
        local: 'São Paulo',
        latitude: startPoint.lat,
        longitude: startPoint.lon
      };

      // Lógica para enviar dados para um aparelho externo
      // Exemplo de chamada de API
      fetch('https://api.example.com/senddata', {
        method: 'POST',
        body: JSON.stringify(dados),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('Dados enviados com sucesso:', data);
      })
      .catch(error => {
        console.error('Erro ao enviar dados:', error);
      });
    }
  </script>
  <script>
    initMap();
  </script>
</body>
</html>
